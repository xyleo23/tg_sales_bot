# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∏ –¥–æ—Ä–∞–±–æ—Ç–∫–µ TG Sales Bot

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (–≤–Ω–µ—Å–µ–Ω—ã –≤ –∫–æ–¥)

1. **–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –±–æ—Ç–∞** ‚Äî –≤ inviting –∏ warming —É–±—Ä–∞–Ω–æ `bot.session.close()`, —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ —Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º.
2. **–£—Ç–µ—á–∫–∞ —Å–µ—Å—Å–∏–∏ –≤ mailing** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω `try/finally` –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è `bot.session` –ø—Ä–∏ –ª—é–±–æ–º –≤—ã—Ö–æ–¥–µ –∏–∑ –∑–∞–¥–∞—á–∏.
3. **datetime.utcnow()** ‚Äî –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ `datetime.now(timezone.utc)` (deprecated –≤ Python 3.12+).
4. **–ü—É—Ç—å –∫ data/** ‚Äî –¥–ª—è SQLite –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∞ –Ω–µ `./data` –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
5. **–î—É–±–ª–∏—Ä—É—é—â–∏–µ –∏–º–ø–æ—Ä—Ç—ã** ‚Äî —É–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ (Channel, Chat, StateFilter).
6. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç** ‚Äî –≤ `extend_or_create` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ naive datetime –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å timezone-aware.

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–æ—Ä–∞–±–æ—Ç–∫–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ TG_API_ID / TG_API_HASH ‚úÖ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –≤ .env –Ω–µ –∑–∞–¥–∞–Ω—ã TG_API_ID –∏ TG_API_HASH, –ø–∞—Ä—Å–µ—Ä—ã, —Ä–∞—Å—Å—ã–ª–∫–∞, –∏–Ω–≤–∞–π—Ç–∏–Ω–≥ –∏ –ø—Ä–æ–≥—Ä–µ–≤ –ø–∞–¥–∞—é—Ç —Å –æ—à–∏–±–∫–æ–π Telethon.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ `bot.utils.is_telethon_configured()` –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ flow:
```python
if not TG_API_ID or not TG_API_HASH:
    await message.answer("–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: TG_API_ID –∏ TG_API_HASH –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–¥–∞–Ω—ã –≤ .env. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
    return
```

### 2. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–º—ë–Ω –∞—É–¥–∏—Ç–æ—Ä–∏–π –∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—É–¥–∏—Ç–æ—Ä–∏–π/–∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∏–º–µ–Ω–µ–º, —á—Ç–æ –ø—É—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ (user_id + name) –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, –ª–∏–±–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å id –≤ —Å–ø–∏—Å–∫–∞—Ö (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ).

### 3. –£–¥–∞–ª–µ–Ω–∏–µ .session –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏–∑ –ë–î —Ñ–∞–π–ª .session –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ.

**–†–µ—à–µ–Ω–∏–µ:** –í `AccountRepo.delete` –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏ —É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª:
```python
path = SESSIONS_DIR / acc.session_filename
if path.exists():
    path.unlink(missing_ok=True)
```

### 4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–∞—Ä—Å–µ—Ä –º–æ–∂–µ—Ç —Å–æ–±—Ä–∞—Ç—å –¥–µ—Å—è—Ç–∫–∏ —Ç—ã—Å—è—á –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤; —Ä–∞—Å—Å—ã–ª–∫–∞ –ø–æ —Ç–∞–∫–æ–π –±–∞–∑–µ –∑–∞–π–º—ë—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ —É–≤–µ–ª–∏—á–∏—Ç —Ä–∏—Å–∫ –±–∞–Ω–∞.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5000 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –Ω–∞ –∞—É–¥–∏—Ç–æ—Ä–∏—é –¥–ª—è trial, –±–æ–ª—å—à–µ –¥–ª—è paid) –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏.

### 5. –û—á–µ—Ä–µ–¥–∏ –≤–º–µ—Å—Ç–æ asyncio.create_task

**–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (–ø–∞—Ä—Å–µ—Ä, —Ä–∞—Å—Å—ã–ª–∫–∞, –∏–Ω–≤–∞–π—Ç–∏–Ω–≥, –ø—Ä–æ–≥—Ä–µ–≤) –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `asyncio.create_task`. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤—Å–µ –∑–∞–¥–∞—á–∏ —Ç–µ—Ä—è—é—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis + ARQ/Celery –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π. –ó–∞–¥–∞—á–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –º–æ–∂–Ω–æ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞. –í `requirements.txt` —É–∂–µ –µ—Å—Ç—å arq.

### 6. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

**–ü—Ä–æ–±–ª–µ–º–∞:** `init_db` —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ö–µ–º—É –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–æ–Ω–æ–∫.

**–†–µ—à–µ–Ω–∏–µ:** –í–Ω–µ–¥—Ä–∏—Ç—å Alembic (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥) –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å –µ—ë.

### 7. –†–æ–ª—å AI –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –º–æ–¥–µ–ª–∏ Mailing –µ—Å—Ç—å –ø–æ–ª–µ `ai_role`, –Ω–æ –æ–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –í –ø–ª–∞–Ω–µ –±—ã–ª–∞ ¬´—Ä–æ–ª—å ChatGPT –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç¬ª –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–æ–≤ –≤ –ª–∏—á–∫—É.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –≤–æ—Ä–∫–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–∏—á–∫—É –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ—Ä–µ–∑ Telethon) –∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `ai_role` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ OpenAI –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç.

### 8. Rate limiting –∏ –∞–Ω—Ç–∏—Å–ø–∞–º

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ —Ä–∞—Å—Å—ã–ª–æ–∫ –ø–æ–¥—Ä—è–¥, —á—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∏—Å–∫ –±–∞–Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:** –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è; –¥–æ–±–∞–≤–∏—Ç—å ¬´–æ—Ö–ª–∞–∂–¥–µ–Ω–∏–µ¬ª –º–µ–∂–¥—É —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ —á–∞—â–µ 1 –≤ —á–∞—Å).

### 9. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∞—É–¥–∏—Ç–∞: –∫—Ç–æ, –∫–æ–≥–¥–∞ –∏ —á—Ç–æ –¥–µ–ª–∞–ª (—Ä–∞—Å—Å—ã–ª–∫–∞, –ø–∞—Ä—Å–∏–Ω–≥ –∏ —Ç.–¥.).

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `audit_log` (user_id, action, details, created_at) –∏ –ø–∏—Å–∞—Ç—å —Ç—É–¥–∞ –∫–ª—é—á–µ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.

### 10. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö ‚úÖ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ –º–æ–∂–µ—Ç ¬´—Ä–æ–Ω—è—Ç—å¬ª –±–æ—Ç–∞ –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π `@dp.error()` handler –≤ `bot.main` (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):
```python
@dp.errors()
async def global_error_handler(event, exception):
    logger.exception("Unhandled error: %s", exception)
    # –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
```

### 11. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ ‚úÖ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–¥–µ—Ä–∂–∫–∏ (30‚Äì90 —Å–µ–∫ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏, 5 —Å–µ–∫ –¥–ª—è –∏–Ω–≤–∞–π—Ç–∏–Ω–≥–∞) –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã.

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å–µ–Ω—ã –≤ .env: `MAILING_DELAY_MIN`, `MAILING_DELAY_MAX`, `MAILING_MAX_PER_ACCOUNT`, `INVITE_DELAY_SEC`.

### 12. –≠–∫—Å–ø–æ—Ä—Ç –∞—É–¥–∏—Ç–æ—Ä–∏–∏ ‚úÖ (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (CSV/Excel).

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ ¬´üì• –≠–∫—Å–ø–æ—Ä—Ç¬ª –¥–ª—è –∫–∞–∂–¥–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è CSV (utf-8-sig –¥–ª—è Excel) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ñ–∞–π–ª–æ–º.

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–¥–∞—á–∞ |
|-----------|--------|
| ~~–í—ã—Å–æ–∫–∏–π~~   | ~~–ü—Ä–æ–≤–µ—Ä–∫–∞ TG_API_ID/TG_API_HASH (–ø.1)~~ ‚úÖ |
| ~~–í—ã—Å–æ–∫–∏–π~~   | ~~–£–¥–∞–ª–µ–Ω–∏–µ .session –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ (–ø.3)~~ ‚úÖ |
| ~~–í—ã—Å–æ–∫–∏–π~~   | ~~–ì–ª–æ–±–∞–ª—å–Ω—ã–π error handler (–ø.10)~~ ‚úÖ |
| ~~–°—Ä–µ–¥–Ω–∏–π~~   | ~~–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (–ø.11)~~ ‚úÖ |
| ~~–°—Ä–µ–¥–Ω–∏–π~~   | ~~–≠–∫—Å–ø–æ—Ä—Ç –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (–ø.12)~~ ‚úÖ |
| –°—Ä–µ–¥–Ω–∏–π   | –û—á–µ—Ä–µ–¥–∏ Redis/ARQ (–ø.5) |
| –°—Ä–µ–¥–Ω–∏–π   | –ú–∏–≥—Ä–∞—Ü–∏–∏ Alembic (–ø.6) |
| –ù–∏–∑–∫–∏–π    | AI-–∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã (–ø.7), —ç–∫—Å–ø–æ—Ä—Ç –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (–ø.12) |
